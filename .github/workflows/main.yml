name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: AzureDeployment # Optional: Define an environment for better secret management

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Docker Login to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and Push Backend Image
      run: |
        az acr build --registry ${{ env.ACR_NAME }} --image rag_chatbot:latest -f dockerfile . --cache-from ${{ env.ACR_NAME }}.azurecr.io/rag_chatbot:latest
      env:
        ACR_NAME: ragacranujkumar # Replace with your ACR name

    - name: Build and Push Frontend Image
      run: |
        az acr build --registry ${{ env.ACR_NAME }} --image frontend:latest -f frontend/ai-chatbot-ui/Dockerfile frontend/ai-chatbot-ui --cache-from ${{ env.ACR_NAME }}.azurecr.io/frontend:latest
      env:
        ACR_NAME: ragacranujkumar # Replace with your ACR name

    - name: Run Deployment Script
      run: |
        chmod +x deploy.sh
        ./deploy.sh
      env:
        RESOURCE_GROUP: rag-app-rg
        LOCATION: eastus
        ACR_NAME: ragacranujkumar
        STORAGE_ACCOUNT_NAME: ragstorageanujkumar
        FILE_SHARE_NAME: qdrant-storage
        CONTAINER_APP_ENV: rag-app-env
        # Note: ACR_LOGIN_SERVER, STORAGE_ACCOUNT_KEY, LOG_ANALYTICS_WORKSPACE_CLIENT_ID, LOG_ANALYTICS_WORKSPACE_CLIENT_SECRET
        # are generated within the deploy.sh script, so they don't need to be passed as environment variables here.
        # For now, assuming deploy.sh handles their generation/retrieval internally.

    # Placeholder for Backend Tests (if any)
    # - name: Run Backend Tests
    #   run: |
    #     pip install -r requirements.txt
    #     pytest # Or your specific test command
    #   working-directory: src/chatbot_backend # Or your backend root directory

    # Placeholder for Frontend Tests (if any)
    # - name: Run Frontend Tests
    #   run: |
    #     npm install
    #     npm test # Or your specific test command
    #   working-directory: frontend/ai-chatbot-ui # Or your frontend root directory
